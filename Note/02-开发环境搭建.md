# å¼€å‘ç¯å¢ƒæ­å»º

## ä¸€ã€å‰ç«¯ç¯å¢ƒæ­å»º

å°†å‡†å¤‡å¥½çš„ nginx æœåŠ¡å™¨ï¼Œéƒ¨ç½²åˆ°æœ¬åœ°ï¼Œå¹¶å¯åŠ¨ï¼›

- è¯¥æœåŠ¡å™¨ä¸­ï¼Œå·²ç»éƒ¨ç½²å¥½äº†åå°ç®¡ç†ç³»ç»Ÿçš„å‰ç«¯é¡¹ç›®é™æ€èµ„æºã€‚

D:\Devtools\nginx-1.20.2

```txt
â”œâ”€ğŸ“ conf/
â”œâ”€ğŸ“ contrib/
â”œâ”€ğŸ“ docs/
â”œâ”€ğŸ“ html/-------- # å­˜æ”¾äº†å‰ç«¯é¡¹ç›®é™æ€èµ„æº
â”œâ”€ğŸ“ logs/
â”œâ”€ğŸ“ temp/
â””â”€ğŸ“„ nginx.exe---- # å¯åŠ¨æœåŠ¡å™¨
```

## äºŒã€åç«¯ç¯å¢ƒæ­å»º

### 1.é¡¹ç›®å·¥ç¨‹å‡†å¤‡

å°†å‡†å¤‡å¥½çš„ Maven å·¥ç¨‹ï¼Œæ”¾åˆ°æœ¬åœ°ç›®å½•ä¸‹ï¼Œå¹¶ä½¿ç”¨ IDEA æ‰“å¼€ã€‚å…¶ä¸­èšåˆäº†ä¸‰ä¸ªå·¥ç¨‹ã€‚

D:\Workshop\project\sky-takeout\sky-takeout-backend

```txt
â”œâ”€ğŸ“ sky-common/
â”œâ”€ğŸ“ sky-pojo/
â”œâ”€ğŸ“ sky-server/
â”œâ”€ğŸ“„ .gitignore
â””â”€ğŸ“„ pom.xml
```

è¿™å‡ ä¸ªå·¥ç¨‹çš„ä½œç”¨ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š

| **åºå·** | **åç§°**     | **è¯´æ˜**                                                     |
| -------- | ------------ | ------------------------------------------------------------ |
| 1        | sky-take-out | Maven çˆ¶å·¥ç¨‹ï¼Œç»Ÿä¸€ç®¡ç†ä¾èµ–ç‰ˆæœ¬ï¼Œèšåˆå…¶ä»–å­æ¨¡å—               |
| 2        | sky-common   | å­æ¨¡å—ï¼Œå­˜æ”¾å…¬å…±ç±»ï¼Œä¾‹å¦‚ï¼šå·¥å…·ç±»ã€å¸¸é‡ç±»ã€å¼‚å¸¸ç±»ç­‰           |
| 3        | sky-pojo     | å­æ¨¡å—ï¼Œå­˜æ”¾å®ä½“ç±»ã€VOã€DTO ç­‰                               |
| 4        | sky-server   | å­æ¨¡å—ï¼Œåç«¯æœåŠ¡ï¼Œå­˜æ”¾é…ç½®æ–‡ä»¶ã€Controllerã€Serviceã€Mapper ç­‰ |

sky-common æ¨¡å—ï¼Œæ¯ä¸ªåŒ…çš„ä½œç”¨ï¼š

| åç§°        | è¯´æ˜                              |
| ----------- | --------------------------------- |
| constant    | å­˜æ”¾ç›¸å…³å¸¸é‡ç±»                    |
| context     | å­˜æ”¾ä¸Šä¸‹æ–‡ç±»                      |
| enumeration | é¡¹ç›®çš„æšä¸¾ç±»å­˜å‚¨                  |
| exception   | å­˜æ”¾è‡ªå®šä¹‰å¼‚å¸¸ç±»                  |
| json        | å¤„ç† json è½¬æ¢çš„ç±»                |
| properties  | å­˜æ”¾ Spring Boot ç›¸å…³çš„é…ç½®å±æ€§ç±» |
| result      | è¿”å›ç»“æœç±»çš„å°è£…                  |
| utils       | å¸¸ç”¨å·¥å…·ç±»                        |

sky-pojo æ¨¡å—ï¼Œæ¯ä¸ªåŒ…çš„ä½œç”¨ï¼š

| **åç§°** | **è¯´æ˜**                                               |
| -------- | ------------------------------------------------------ |
| entity   | å®ä½“ï¼Œé€šå¸¸å’Œæ•°æ®åº“ä¸­çš„è¡¨å¯¹åº”                           |
| dto      | æ•°æ®ä¼ è¾“å¯¹è±¡ï¼Œé€šå¸¸ç”¨äºç¨‹åºä¸­å„å±‚ä¹‹é—´ä¼ é€’æ•°æ®           |
| vo       | è§†å›¾å¯¹è±¡ï¼Œä¸ºå‰ç«¯å±•ç¤ºæ•°æ®æä¾›çš„å¯¹è±¡                     |
| pojo     | æ™®é€š Java å¯¹è±¡ï¼Œåªæœ‰å±æ€§å’Œå¯¹åº”çš„ getter å’Œ setter æ–¹æ³• |

- PoJo åŒ…å«äº† Entityã€DTOã€VOï¼›

sky-server æ¨¡å—ä¸­ï¼Œå­˜æ”¾çš„æ˜¯é…ç½®æ–‡ä»¶ã€é…ç½®ç±»ã€æ‹¦æˆªå™¨ã€controllerã€serviceã€mapperã€å¯åŠ¨ç±»ç­‰ã€‚

sky-server æ¨¡å—çš„æ¯ä¸ªåŒ…çš„ä½œç”¨ï¼š

| åç§°           | è¯´æ˜               |
| -------------- | ------------------ |
| config         | å­˜æ”¾é…ç½®ç±»         |
| controller     | å­˜æ”¾ controller ç±» |
| interceptor    | å­˜æ”¾æ‹¦æˆªå™¨ç±»       |
| mapper         | å­˜æ”¾ mapper æ¥å£   |
| service        | å­˜æ”¾ service ç±»    |
| SkyApplication | å¯åŠ¨ç±»             |

### 2.æ•°æ®åº“å‡†å¤‡

è§æ•°æ®åº“è®¾è®¡æ–‡æ¡£ï¼š

æ‰§è¡Œå‡†å¤‡å¥½çš„ sql è„šæœ¬ã€‚

### 3.å‰åç«¯è¿é€šæ€§æµ‹è¯•

å¯åŠ¨ Nginx æœåŠ¡å™¨ï¼Œåœ¨æµè§ˆå™¨ä¸­è®¿é—® `localhost:80`

å¯åŠ¨åç«¯æœåŠ¡ã€‚

sky-takeout-backend/sky-pojo/src/main/java/com/sky/vo/EmployeeLoginVO.java

```java
package com.sky.vo;

import io.swagger.v3.oas.annotations.media.Schema;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.io.Serializable;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Schema(description = "å‘˜å·¥ç™»å½•è¿”å›çš„æ•°æ®æ ¼å¼")
public class EmployeeLoginVO implements Serializable {
    @Schema(description = "ä¸»é”®å€¼")
    private Long id;
    @Schema(description = "ç”¨æˆ·å")
    private String userName;
    @Schema(description = "å§“å")
    private String name;
    @Schema(description = "jwtä»¤ç‰Œ")
    private String token;
}
```

- Lombok æä¾›äº† `@Builder` æ³¨è§£ï¼Œç”¨äºä½¿ç”¨é“¾å¼ç¼–ç¨‹ï¼Œå°è£…ä¸€ä¸ªå®ä¾‹å¯¹è±¡ã€‚

EmployeeController ç±»

sky-takeout-backend/sky-server/src/main/java/com/sky/controller/admin/EmployeeController.java

```java
â€¦â€¦

@PostMapping("/login")
public Result<EmployeeLoginVO> login(@RequestBody EmployeeLoginDTO employeeLoginDTO) {
    log.info("å‘˜å·¥ç™»å½•ï¼š{}", employeeLoginDTO);

    Employee employee = employeeService.login(employeeLoginDTO);

    // ç™»å½•æˆåŠŸåï¼Œç”Ÿæˆ jwt ä»¤ç‰Œ
    Map<String, Object> claims = new HashMap<>();
    claims.put(JwtClaimsConstant.EMP_ID, employee.getId());

    String token = JwtUtil.createJWT(
            jwtProperties.getAdminSecretKey(),
            jwtProperties.getAdminTtl(),
            claims
    );

    EmployeeLoginVO employeeLoginVO = EmployeeLoginVO.builder()
            .id(employee.getId())
            .userName(employee.getUsername())
            .name(employee.getName())
            .token(token)
            .build();

    return Result.success(employeeLoginVO);
}

â€¦â€¦
```

### 4.Nginx åå‘ä»£ç†é…ç½®

å‰ç«¯æµè§ˆå™¨å‘é€çš„è¯·æ±‚ï¼š`http://localhost/api/employee/login`

åç«¯æœåŠ¡å™¨å¤„ç†çš„è¯·æ±‚ï¼š`/admin/employee/login`

å‘ç°è¿™ä¸¤ä¸ªæ¨¡å—å¯¹åº”ä¸ä¸Šï¼Œè¿™æ˜¯å› ä¸ºï¼šNginx å°†å‰ç«¯å‘é€çš„è¯·æ±‚ï¼Œè½¬å‘åˆ°äº†åç«¯æœåŠ¡å™¨ä¸Šã€‚

Nginx åå‘ä»£ç†çš„å¥½å¤„ï¼š

- æé«˜è®¿é—®é€Ÿåº¦ï¼šNginx æœ¬èº«å¯ä»¥è¿›è¡Œç¼“å­˜ï¼Œå¦‚æœè®¿é—®çš„åŒä¸€æ¥å£ï¼Œå¹¶ä¸”åšäº†æ•°æ®ç¼“å­˜ï¼ŒNginx å°±å¯ç›´æ¥æŠŠæ•°æ®è¿”å›ï¼Œä¸éœ€è¦çœŸæ­£åœ°è®¿é—®åç«¯æœåŠ¡ç«¯ã€‚

- è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼šæŠŠå¤§é‡çš„è¯·æ±‚ï¼ŒæŒ‰ç…§æŒ‡å®šçš„æ–¹å¼ï¼Œå‡è¡¡çš„åˆ†é…ç»™é›†ç¾¤ä¸­çš„æ¯å°æœåŠ¡å™¨ã€‚

- ä¿è¯åç«¯æœåŠ¡å®‰å…¨ï¼šä¸€èˆ¬åå°æœåŠ¡åœ°å€ä¸ä¼šæš´éœ²ï¼Œæ‰€ä»¥ä¸èƒ½ä½¿ç”¨æµè§ˆå™¨ç›´æ¥è®¿é—®ã€‚

![Nginxåå‘ä»£ç†](../NodeAssets/Nginxåå‘ä»£ç†.png)

Nginx é…ç½®æ–‡ä»¶ä¸­ï¼Œé…ç½®åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡ï¼š

```nginx
http {
  upstream webservers {
    server 127.0.0.1:8080 weight=90 ;
    #server 127.0.0.1:8088 weight=10 ;
  }

  server {
    listen 80;
    server_name localhost;

    location /api/ {
      proxy_pass http://localhost:8080/admin/; # åå‘ä»£ç†,å¤„ç†ç®¡ç†ç«¯å‘é€çš„è¯·æ±‚
      # proxy_pass http://webservers/admin/; # è´Ÿè½½å‡è¡¡
    }
  }
}
```

è´Ÿè½½å‡è¡¡çš„ç­–ç•¥ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š

| **åç§°**     | **è¯´æ˜**                                                   |
| ------------ | ---------------------------------------------------------- |
| è½®è¯¢         | é»˜è®¤æ–¹å¼                                                   |
| `weight`     | æƒé‡æ–¹å¼ï¼Œé»˜è®¤ä¸º 1ï¼Œæƒé‡è¶Šé«˜ï¼Œè¢«åˆ†é…çš„å®¢æˆ·ç«¯è¯·æ±‚å°±è¶Šå¤š     |
| `ip_hash`    | ä¾æ® ip åˆ†é…æ–¹å¼ï¼Œè¿™æ ·æ¯ä¸ªè®¿å®¢å¯ä»¥å›ºå®šè®¿é—®ä¸€ä¸ªåç«¯æœåŠ¡     |
| `least_conn` | ä¾æ®æœ€å°‘è¿æ¥æ–¹å¼ï¼ŒæŠŠè¯·æ±‚ä¼˜å…ˆåˆ†é…ç»™è¿æ¥æ•°å°‘çš„åç«¯æœåŠ¡       |
| `url_hash`   | ä¾æ® url åˆ†é…æ–¹å¼ï¼Œè¿™æ ·ç›¸åŒçš„ url ä¼šè¢«åˆ†é…åˆ°åŒä¸€ä¸ªåç«¯æœåŠ¡ |
| `fair`       | ä¾æ®å“åº”æ—¶é—´æ–¹å¼ï¼Œå“åº”æ—¶é—´çŸ­çš„æœåŠ¡å°†ä¼šè¢«ä¼˜å…ˆåˆ†é…           |

å…·ä½“é…ç½®æ–¹å¼ï¼š

è½®è¯¢ï¼š

```nginx
upstream webservers{
    server 192.168.100.128:8080;
    server 192.168.100.129:8080;
}
```

weightï¼š

```nginx
upstream webservers{
    server 192.168.100.128:8080 weight=90;
    server 192.168.100.129:8080 weight=10;
}
```

ip_hashï¼š

```nginx
upstream webservers{
    ip_hash;
    server 192.168.100.128:8080;
    server 192.168.100.129:8080;
}
```

least_connï¼š

```nginx
upstream webservers{
    least_conn;
    server 192.168.100.128:8080;
    server 192.168.100.129:8080;
}
```

url_hashï¼š

```nginx
upstream webservers{
    hash &request_uri;
    server 192.168.100.128:8080;
    server 192.168.100.129:8080;
}
```

fairï¼š

```nginx
upstream webservers{
    server 192.168.100.128:8080;
    server 192.168.100.129:8080;
    fair;
}
```

## ä¸‰ã€å®Œå–„ç™»å½•åŠŸèƒ½

å¯†ç æ˜æ–‡å­˜å‚¨ï¼Œå®‰å…¨æ€§ä½ã€‚è¦å¯¹å¯†ç åŠ å¯†å¤„ç†ï¼š

> è¿™é‡Œä½¿ç”¨ MD5 çš„åŠ å¯†æ–¹å¼ï¼Œå®ƒæ˜¯ä¸å¯é€†çš„ï¼Œåªèƒ½ç”±æ˜æ–‡å¾—åˆ°å¯†æ–‡ã€‚

æœ‰ä¸¤æ­¥æ“ä½œï¼›

1. ä¿®æ”¹æ•°æ®åº“ä¸­æ˜æ–‡å¯†ç ï¼Œæ”¹ä¸º MD5 åŠ å¯†åçš„å¯†æ–‡ã€‚
2. ä¿®æ”¹ Java ä»£ç ï¼Œå‰ç«¯æäº¤çš„å¯†ç è¿›è¡Œ MD5 åŠ å¯†åï¼Œå†è·Ÿæ•°æ®åº“ä¸­çš„å¯†ç è¿›è¡Œæ¯”å¯¹ã€‚

Spring æ¡†æ¶æä¾›äº†ä¸€ä¸ªå·¥å…·ç±» `DigestUtils`ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæ–¹æ³• `md5DigestAsHex`

åœ¨æµ‹è¯•ç±»ä¸­ï¼Œæµ‹è¯• Spring æ¡†æ¶çš„ MD5 åŠ å¯†èƒ½åŠ›ï¼š

sky-takeout-backend/sky-server/src/test/java/com/sky/MyTest.java

```java
package com.sky;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.util.DigestUtils;

@SpringBootTest
public class MyTest {
    @Test
    public void testMd5() {
        String res = DigestUtils.md5DigestAsHex("123456".getBytes());
        System.out.println(res);
    }
}
```

åœ¨ `EmployeeServiceImpl` ç±»ä¸­ï¼Œå°†å‰ç«¯ä¼ é€’è¿‡æ¥çš„å¯†ç ï¼Œåš MD5 åŠ å¯†å¤„ç†ï¼Œå†ä¸æ•°æ®åº“ä¸­çš„å¯†ç è¿›è¡Œæ¯”å¯¹ï¼š

sky-takeout-backend/sky-server/src/main/java/com/sky/service/impl/EmployeeServiceImpl.java

```java
â€¦â€¦

/**
 * å‘˜å·¥ç™»å½•
 *
 * @param employeeLoginDTO
 * @return
 */
public Employee login(EmployeeLoginDTO employeeLoginDTO) {
    String username = employeeLoginDTO.getUsername();
    String password = employeeLoginDTO.getPassword();

    //1ã€æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢æ•°æ®åº“ä¸­çš„æ•°æ®
    Employee employee = employeeMapper.getByUsername(username);

    //2ã€å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µï¼ˆç”¨æˆ·åä¸å­˜åœ¨ã€å¯†ç ä¸å¯¹ã€è´¦å·è¢«é”å®šï¼‰
    if (employee == null) {
        //è´¦å·ä¸å­˜åœ¨
        throw new AccountNotFoundException(MessageConstant.ACCOUNT_NOT_FOUND);
    }

    password = DigestUtils.md5DigestAsHex(password.getBytes());
    //å¯†ç æ¯”å¯¹
    if (!password.equals(employee.getPassword())) {
        //å¯†ç é”™è¯¯
        throw new PasswordErrorException(MessageConstant.PASSWORD_ERROR);
    }

    if (employee.getStatus() == StatusConstant.DISABLE) {
        //è´¦å·è¢«é”å®š
        throw new AccountLockedException(MessageConstant.ACCOUNT_LOCKED);
    }

    //3ã€è¿”å›å®ä½“å¯¹è±¡
    return employee;
}

â€¦â€¦
```
