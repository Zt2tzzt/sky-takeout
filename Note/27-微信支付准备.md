# 微信支付准备

## 一、微信支付了解

在小程序中，使用微信支付，实现用户订单支付。

[微信支付产品介绍](https://pay.weixin.qq.com/static/product/product_index.shtml#payment_product)；[小程序微信支付接入流程介绍](https://pay.weixin.qq.com/static/applyment_guide/applyment_detail_miniapp.shtml)；[微信支付时序图](https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=8_3)；[JSAPI 下单文档](https://pay.weixin.qq.com/docs/merchant/apis/jsapi-payment/direct-jsons/jsapi-prepay.html)；[小程序调起微信支付](https://pay.weixin.qq.com/docs/merchant/apis/mini-program-payment/mini-transfer-payment.html)。

## 二、微信支付准备

### 2.1.数据安全机制

根据[微信支付时序图](https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=8_3)可知，完成微信支付，有两个关键的步骤：

1. 在商户系统当中，调用微信后台的一个下单接口，就是生成预支付交易单。
2. 支付成功后，微信后台会调用商户系统接口，推送消息。

以上两个步骤，对应的两个接口，数据的安全性要求是非常高的。

为此，微信提供的方案，就是对数据进行加密、解密、签名多种方式。

要完成数据加密、解密，需要提前准备相应的一些文件，其实就是一些证书。获取微信商户平台的两个文件：

- 平台证书：
- 商户私钥文件；

### 2.2.微信后台调用商户系统接口

微信后台会调用到商户系统接口，推送支付的结果；

当前开发环境，商户系统所在服务器的 ip 地址，就是电脑本地的 ip 地址，即一个局域网内的 ip 地址，微信后台是无法访问到的。

因此要使用内网穿透。获得一个临时域名，而这个临时域名是一个公网 ip，这样，微信后台就可以访问商户系统了。

使用 [cpolar 软件](https://dashboard.cpolar.com/get-started)开启内网穿透的功能。

1. 注册并下载 cpolar；
2. 为 cpolar 指定 authtoken，并执行命令；[参考文档](https://dashboard.cpolar.com/auth)
   - Linux / Mac OS 参考文档；Windows 执行的命令是 `cpolar.exe authtoken yourAuthtoken`
3. 指定本地端口，启动 Http 隧道；[参考文档](https://dashboard.cpolar.com/auth)
   - Linux / Mac OS 参考文档；Windows 执行的命令是 `cpolar.exe http port`

### 2.3.配置文件类 WeChatProperties

sky-takeout-backend/sky-common/src/main/java/com/sky/properties/WeChatProperties.java

```java
package com.sky.properties;

import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;

@Component
@ConfigurationProperties(prefix = "sky.wechat")
@Data
public class WeChatProperties {
    private String appid; //小程序的 appid
    private String secret; //小程序的秘钥
    private String mchid; //商户号
    private String mchSerialNo; //商户 API 证书的证书序列号
    private String privateKeyFilePath; //商户私钥文件
    private String apiV3Key; //证书解密的密钥
    private String weChatPayCertFilePath; //平台证书
    private String notifyUrl; //支付成功的回调地址
    private String refundNotifyUrl; //退款成功的回调地址
}
```

在配置文件中，添加对应的属性：
